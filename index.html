<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>è‹±è¯­æ™ºèƒ½èƒŒè¯æ‰“å¡å¹³å°</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  font-family:Arial, sans-serif;
  padding:20px;
  max-width:900px;
  margin:auto;
}
button,input,select{
  padding:10px;
  margin:6px;
  font-size:16px;
}
.word{
  font-size:28px;
  font-weight:bold;
  color:#2c3e50;
}
.card{
  border:1px solid #ddd;
  padding:15px;
  border-radius:10px;
  margin-top:15px;
}
.info{
  color:#666;
  margin-top:10px;
}
.record-item{
  cursor:pointer;
  color:#3498db;
  margin:6px 0;
}
.record-item:hover{
  text-decoration:underline;
}
.reset{
  margin-top:20px;
  background:#e74c3c;
  color:#fff;
  border:none;
  border-radius:8px;
}
</style>
</head>
<body>

<h1>ğŸ“– è‹±è¯­æ™ºèƒ½èƒŒè¯æ‰“å¡å¹³å°</h1>

<label>æ¯æ—¥å•è¯æ•°ï¼š</label>
<input type="number" id="dailyCount" value="10" min="1">

<label>é¡ºåºï¼š</label>
<select id="orderMode">
  <option value="fixed">å›ºå®šé¡ºåº</option>
  <option value="random">éšæœºé¡ºåº</option>
</select>

<br><br>
<button onclick="start()">å¼€å§‹ä»Šæ—¥æ‰“å¡</button>
<button class="reset" onclick="resetAll()">ğŸ—‘ é‡ç½®æ‰€æœ‰è®°å½•</button>

<div id="card" class="card"></div>
<div id="progress" class="info"></div>
<div id="record" class="info"></div>

<script>
/* ===============================
   å¸¸é‡ & Key
================================ */
const WORD_URL =
  "https://raw.githubusercontent.com/first20hours/google-10000-english/master/google-10000-english-no-swears.txt";

const CACHE_KEY = "WORD_CACHE_V2";
const RECORD_KEY = "PUNCH_RECORD";
const LEARNED_KEY = "LEARNED_WORDS";

/* ===============================
   å…¨å±€çŠ¶æ€
================================ */
let words = [];
let todayList = [];
let index = 0;

/* ===============================
   å·¥å…·ï¼šä»Šå¤©æ—¥æœŸ
================================ */
function todayStr(){
  return new Date().toLocaleDateString();
}

/* ===============================
   åŠ è½½è¯åº“
================================ */
async function loadWords(){
  if(localStorage.getItem(CACHE_KEY)){
    words = JSON.parse(localStorage.getItem(CACHE_KEY));
    return;
  }
  const res = await fetch(WORD_URL);
  const txt = await res.text();
  words = txt.split("\n").filter(w=>w.trim()).map(w=>({w}));
  localStorage.setItem(CACHE_KEY, JSON.stringify(words));
}
loadWords();

/* ===============================
   å¼€å§‹ä»Šæ—¥æ‰“å¡ï¼ˆâ­ å»é‡é€»è¾‘ï¼‰
================================ */
function start(){
  const n = parseInt(dailyCount.value);
  const order = orderMode.value;

  const learned = new Set(
    JSON.parse(localStorage.getItem(LEARNED_KEY) || "[]")
  );

  let pool = words.filter(w => !learned.has(w.w));

  if(pool.length === 0){
    card.innerHTML = "ğŸ‰ ä½ å·²ç»å­¦å®Œæ‰€æœ‰å•è¯ï¼";
    return;
  }

  if(order === "random") pool.sort(()=>Math.random()-0.5);

  todayList = pool.slice(0, n);
  index = 0;
  showWord();
}

/* ===============================
   æ˜¾ç¤ºå•è¯
================================ */
function showWord(){
  if(index >= todayList.length){
    completePunch();
    return;
  }
  const w = todayList[index].w;
  card.innerHTML = `
    <div class="word">${w}</div>
    <button onclick="nextWord()">ä¸‹ä¸€ä¸ª</button>
  `;
  progress.innerText = `è¿›åº¦ï¼š${index+1} / ${todayList.length}`;
}

function nextWord(){
  index++;
  showWord();
}

/* ===============================
   æ‰“å¡å®Œæˆï¼ˆâ­ è®°å½• + å·²å­¦è¯ï¼‰
================================ */
function completePunch(){
  const rec = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
  const learned = new Set(
    JSON.parse(localStorage.getItem(LEARNED_KEY) || "[]")
  );

  const wordsToday = todayList.map(w=>w.w);

  wordsToday.forEach(w => learned.add(w));

  rec.push({
    date: todayStr(),
    count: wordsToday.length,
    words: wordsToday
  });

  localStorage.setItem(RECORD_KEY, JSON.stringify(rec));
  localStorage.setItem(LEARNED_KEY, JSON.stringify([...learned]));

  /* â­ åœ£è¯æ ‘è”åŠ¨ */
  localStorage.setItem("TREE_RECORD_INDEX", rec.length - 1);

  card.innerHTML = "ğŸ‰ ä»Šæ—¥æ‰“å¡å®Œæˆï¼";
  progress.innerText = `ä»Šæ—¥å­¦ä¹  ${wordsToday.length} ä¸ªæ–°å•è¯`;
  showRecord();
}

/* ===============================
   æ‰“å¡è®°å½•
================================ */
function showRecord(){
  const rec = JSON.parse(localStorage.getItem(RECORD_KEY) || "[]");
  if(!rec.length){
    record.innerHTML = "æš‚æ— æ‰“å¡è®°å½•";
    return;
  }

  let html = "ğŸ“ æ‰“å¡è®°å½•ï¼ˆç‚¹å‡»è¿›å…¥åœ£è¯æ ‘ï¼‰ï¼š<br>";
  rec.slice().reverse().forEach((r,i)=>{
    const realIndex = rec.length - 1 - i;
    html += `
      <div class="record-item"
           onclick="openTree(${realIndex})">
        ğŸ„ ${r.date}ï¼ˆ${r.count} è¯ï¼‰
      </div>
    `;
  });
  record.innerHTML = html;
}

/* ===============================
   è·³è½¬åœ£è¯æ ‘
================================ */
function openTree(i){
  localStorage.setItem("TREE_RECORD_INDEX", i);
  window.location.href = "tree.html";
}

/* ===============================
   é‡ç½®æ‰€æœ‰æ•°æ®
================================ */
function resetAll(){
  if(!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å­¦ä¹ è®°å½•å—ï¼Ÿ")){
    return;
  }
  localStorage.removeItem(RECORD_KEY);
  localStorage.removeItem(LEARNED_KEY);
  localStorage.removeItem("TREE_RECORD_INDEX");
  localStorage.removeItem("REVIEW_WORD");

  card.innerHTML = "ğŸ”„ å·²é‡ç½®ï¼Œè¯·é‡æ–°å¼€å§‹å­¦ä¹ ";
  progress.innerText = "";
  record.innerText = "";
}

/* åˆå§‹åŒ– */
showRecord();
</script>

</body>
</html>
